/* 
 * Copyright (c) 2014, Daan Pape
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without 
 * modification, are permitted provided that the following conditions are met:
 * 
 *     1. Redistributions of source code must retain the above copyright 
 *        notice, this list of conditions and the following disclaimer.
 *
 *     2. Redistributions in binary form must reproduce the above copyright 
 *        notice, this list of conditions and the following disclaimer in the 
 *        documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" 
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE 
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
 * POSSIBILITY OF SUCH DAMAGE.
 * 
 * File:   screen_ssd1306.c
 * Created on September 9, 2014, 11:11 AM
 */

#include <stdint.h>
#include <unistd.h>

#include "../config.h"
#include "screen_ssd1306.h"
#include "../combus/spi.h"
#include "../gpio/gpio.h"

#define SSD1306_LCDHEIGHT 64
#define SSD1306_LCDWIDTH 128

static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] = {
		0xF8, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x38, 0x70, 0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00,
		0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xF8, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x38, 0xF0, 0xE0, 0x80, 0x00,
		0x00, 0x00, 0xC0, 0xE0, 0x70, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x30, 0xF0, 0xC0, 0x80,
		0x00, 0x08, 0x78, 0xF0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF8, 0x38, 0x08,
		0x00, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF0, 0x38, 0x18, 0x00,
		0x00, 0x00, 0xF8, 0xF8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x38, 0x70, 0xE0, 0xC0, 0x00, 0x00,
		0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF3, 0xFF, 0x0E, 0x00, 0x00, 0x00,
		0xFF, 0xFF, 0x06, 0x06, 0x06, 0x06, 0x06, 0x04, 0x0C, 0xBC, 0xF8, 0x60, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03,
		0x03, 0x00, 0x00, 0xFF, 0xFF, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1C, 0xBE, 0xF7, 0xC3, 0x00, 0x00,
		0x00, 0x1F, 0xFF, 0xE1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xFF, 0x3F,
		0x00, 0x00, 0x00, 0x01, 0x0F, 0x7F, 0xF1, 0x81, 0x01, 0xE1, 0xFD, 0x1F, 0x07, 0x00, 0x00, 0x00,
		0x00, 0x00, 0xFF, 0xFF, 0x0C, 0x0C, 0x0C, 0x0C, 0x0E, 0x0F, 0x0F, 0x19, 0xF8, 0xF0, 0x00, 0x00,
		0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF3, 0xFF, 0x0E, 0x00,
		0xC7, 0xC7, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC3, 0xC3, 0xC1, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
		0xC7, 0xC7, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC3, 0xC3, 0xC1, 0xC0, 0xC0, 0xC0, 0xC6, 0xC6,
		0xC6, 0xC6, 0xC6, 0xC7, 0xC7, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
		0xC0, 0xC0, 0xC0, 0xC7, 0xC7, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC3, 0xC3, 0xC1, 0xC0, 0xC0, 0xC0,
		0xC0, 0xC0, 0xC0, 0xC1, 0xC3, 0xC3, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC3, 0xC3, 0xC1, 0xC0, 0xC0,
		0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC1, 0xC7, 0xC7, 0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
		0xC0, 0xC0, 0xC7, 0xC7, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC3, 0xC3, 0xC1, 0xC0, 0xC0,
		0xC0, 0xC0, 0xC7, 0xC7, 0xC6, 0xC6, 0xC6, 0xC6, 0x06, 0x06, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00,
		0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC,
		0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0xF0, 0xF0, 0xE0, 0xC0, 0x80, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC,
		0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFC, 0x00, 0x00, 0x00,
		0xFC, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x00, 0x00, 0xF0, 0x18, 0x04, 0x04, 0x04, 0x04, 0x18,
		0x10, 0x00, 0xFC, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFC, 0xFC, 0x00, 0xFC, 0x00, 0x00, 0xC0, 0x60,
		0x18, 0xFC, 0xFC, 0x00, 0xFC, 0xFC, 0x00, 0xF0, 0x18, 0x04, 0x04, 0x04, 0x04, 0x18, 0x10, 0x00,
		0x18, 0x8C, 0x84, 0xC4, 0x44, 0x4C, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0x07, 0x07, 0x07,
		0x07, 0x07, 0x07, 0x07, 0x0F, 0x1F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFE, 0xF8, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x0C, 0x0F, 0x0F, 0x0C, 0x0C, 0x0C,
		0x0F, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x00, 0x00, 0x03, 0x06, 0x04, 0x0C, 0x08, 0x04, 0x06,
		0x02, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x0F, 0x06, 0x03, 0x00, 0x00,
		0x00, 0x0F, 0x0F, 0x00, 0x0F, 0x0F, 0x00, 0x03, 0x06, 0x04, 0x0C, 0x08, 0x04, 0x06, 0x02, 0x00,
		0x03, 0x04, 0x0C, 0x08, 0x04, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE,
		0xFE, 0xFE, 0xFE, 0xFC, 0xFC, 0xF8, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x80,
		0x80, 0x80, 0x80, 0xC0, 0xC0, 0xE0, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0x7F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x81, 0xC7, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0x7F, 0x3F, 0x3F, 0x1F, 0x0F, 0x07, 0x03,
		0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
		0xFF, 0x7F, 0x7F, 0x7F, 0x3F, 0x3F, 0x1F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


/*
 * Send SPI command to the display
 * @command the command to send
 */
void screen_ssd1306_send_command(uint8_t command)
{
	/* The SPI device pointer */
	int dev = spi_init(0, 8, 25000);

	/* Make the data command line low */
	gpio_write_and_close(SCREEN_SSD1306_DC, 0);

	/* Send the bytes and close the device */
	spi_byte_send_8(dev, command);
}

/*
 * Send SPI data to the display
 * @data the byte to send
 */
void screen_ssd1306_send_data(uint8_t data)
{
	/* The SPI device pointer */
		int dev = spi_init(0, 8, 25000);

		/* Make the data command line high */
		gpio_write_and_close(SCREEN_SSD1306_DC, 1);

		/* Send the bytes and close the device */
		spi_byte_send_8(dev, data);
}

/*
 * Initialize SSD1306 screen OLED device
 */
void screen_ssd1306_init(void)
{
	// Reset the display to start initialization
	gpio_write_and_close(SCREEN_SSD1303_RES, 1);
	usleep(1000);
	gpio_write_and_close(SCREEN_SSD1303_RES, 0);
	usleep(10000);
	gpio_write_and_close(SCREEN_SSD1303_RES, 1);
	usleep(1000);

	/* Start init sequence for 128x64 px */
	screen_ssd1306_send_command(SCREEN_SSD1306_OFF);					// Turn of display
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_CLOCKDIV);			// Set clock division
	screen_ssd1306_send_command(0x80);									// 0x80 is suggested
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_MULTIPLEX);			// Set display multiplex
	screen_ssd1306_send_command(0x3F);
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_OFFSET);				// Set display offset
	screen_ssd1306_send_command(0x00);									// No offset
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_STARTLINE | 0x00);	// Start at line 0
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_CHARGEPUMP);			// Set up chargepump
	screen_ssd1306_send_command(0x14);									// user internal high voltage
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_MEMMODE);			// Set display memory mode
	screen_ssd1306_send_command(0x00);									// 0x00 acts like ks0108
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_SEGREMAP | 0x10);
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_COMSCANDEC);
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_COMPINS);
	screen_ssd1306_send_command(0x12);
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_CONTRAST);			// Set display contrast
	screen_ssd1306_send_command(0xCF);
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_PRECHARGE);			// Set display precharge
	screen_ssd1306_send_command(0xF1);
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_VCOMDETECT);			// Set V com detect
	screen_ssd1306_send_command(0x40);
	screen_ssd1306_send_command(SCREEN_SSD1306_ALLON_RESUME);			// Resume display operation
	screen_ssd1306_send_command(SCREEN_SSD1306_NORMALDISP);				// Non inverted display
	screen_ssd1306_send_command(SCREEN_SSD1306_ON);						// Turn on display

	/* Clear the screen */
	screen_ssd1306_clear();
}

void screen_ssd1306_set_startpage(uint8_t page)
{

}

void screen_ssd1306_set_startcolumn(uint8_t column)
{

}

/*
 * Clear the screen
 */
void screen_ssd1306_clear(void)
{
	uint16_t i;

	screen_ssd1306_send_command(SCREEN_SSD1306_SET_LOWCOLUMN | 0x0);	// low col = 0
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_HIGHCOLUMN | 0x0);	// high col = 0
	screen_ssd1306_send_command(SCREEN_SSD1306_SET_STARTLINE | 0x0);	// line 0

	for(i = 0; i < (SSD1306_LCDWIDTH*SSD1306_LCDHEIGHT/8); ++i){
		screen_ssd1306_send_data(buffer[i]);
	}
}
